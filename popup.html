<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    /* CSS STYLES */
    body { width: 340px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 15px; background: #f8f9fa; color: #333; margin: 0; }
    
    /* Card Styles */
    .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; margin-bottom: 12px; }
    .card h2 { margin: 0 0 5px 0; color: #3d0752; font-size: 16px; font-weight: 700; letter-spacing: 0.5px; }
    .big-num { font-size: 36px; font-weight: 800; color: #ff3269; margin: 8px 0; letter-spacing: -1px; }
    .sub-text { color: #888; font-size: 12px; font-weight: 500; }

    /* Button Styles */
    button { width: 100%; padding: 12px; background: #3d0752; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; margin-top: 5px; transition: background 0.2s; font-size: 14px; }
    button:hover { background: #5a1075; }
    button:disabled { background: #cbd5e0; cursor: not-allowed; }
    .secondary-btn { background: #e2e8f0; color: #475569; margin-top: 8px; }
    .secondary-btn:hover { background: #cbd5e0; }

    /* List Sections */
    .section-title { font-size: 13px; font-weight: 700; color: #475569; text-transform: uppercase; margin: 20px 0 10px 0; border-bottom: 2px solid #ff3269; display: inline-block; }
    
    /* Product Row */
    .prod-row { display: flex; align-items: center; background: white; padding: 10px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #e2e8f0; }
    .count-badge { background: #f1f5f9; color: #333; padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 12px; margin-right: 10px; min-width: 24px; text-align: center; }
    .prod-name { font-size: 13px; font-weight: 600; color: #1e293b; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

    /* Expensive Order Row */
    .exp-row { display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid #ff3269; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .exp-info { display: flex; flex-direction: column; text-align: left; }
    .exp-date { font-size: 11px; color: #64748b; font-weight: 500; }
    .exp-items { font-size: 11px; color: #333; font-weight: 600; margin-top: 2px; max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .exp-price { font-size: 14px; font-weight: 800; color: #3d0752; }

    #results { display: none; padding-bottom: 20px; }
  </style>
</head>
<body>

  <div class="card">
    <h2>üü£ Zepto Lifetime Stats</h2>
    <div class="big-num" id="totalAmount">‚Çπ0</div>
    <div class="sub-text" id="orderCount">0 Orders Tracked</div>
  </div>

  <button id="scanBtn">üîÑ Scan Visible Orders</button>
  <button id="clearBtn" class="secondary-btn">Reset Data</button>

  <div id="results">
    
    <div class="section-title">üí∞ Top 5 Biggest Orders</div>
    <div id="expensiveList"></div>

    <div class="section-title">üèÜ Most Frequent Items</div>
    <div id="topList"></div>

    <p style="font-size:10px; color:#999; text-align:center; margin-top:20px;">
      *Individual item prices are not visible in list view.
    </p>
  </div>

  <script>
    // --- JAVASCRIPT LOGIC ---
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      
      document.getElementById('scanBtn').addEventListener('click', () => {
        const btn = document.getElementById('scanBtn');
        chrome.tabs.query({active: true, currentWindow: true}, (tabs) => {
          if (!tabs[0].url.includes("zepto")) {
            alert("‚ö†Ô∏è Please open the Zepto Orders page first.");
            return;
          }
          btn.innerText = "‚è≥ Scanning...";
          btn.disabled = true;

          chrome.scripting.executeScript({
            target: { tabId: tabs[0].id },
            function: scrapePage
          }, (results) => {
            btn.innerText = "üîÑ Scan Visible Orders";
            btn.disabled = false;
            if (results && results[0] && results[0].result) {
              const count = results[0].result.length;
              if (count === 0) {
                alert("No orders found.\n\nTip: Please scroll down the page to load more history, then click Scan again.");
              } else {
                saveData(results[0].result);
              }
            }
          });
        });
      });

      document.getElementById('clearBtn').addEventListener('click', () => {
        if(confirm("Delete all history?")) {
            chrome.storage.local.clear(loadData);
        }
      });
    });

    function saveData(newOrders) {
      chrome.storage.local.get(['expenses'], (result) => {
        const existing = result.expenses || [];
        let added = 0;
        newOrders.forEach(item => {
          // Prevent duplicates (Unique key: Date + Price)
          if (!existing.some(e => e.date === item.date && e.price === item.price)) {
            existing.push(item);
            added++;
          }
        });
        chrome.storage.local.set({ expenses: existing }, () => {
          loadData();
        });
      });
    }

    function loadData() {
      chrome.storage.local.get(['expenses'], (result) => {
        const expenses = result.expenses || [];
        
        if (expenses.length > 0) {
            document.getElementById('results').style.display = 'block';
        } else {
            document.getElementById('results').style.display = 'none';
        }
        
        // 1. Update Totals
        const total = expenses.reduce((sum, i) => sum + i.price, 0);
        document.getElementById('totalAmount').innerText = '‚Çπ' + total.toLocaleString('en-IN');
        document.getElementById('orderCount').innerText = expenses.length + ' Orders';

        // 2. Top 5 Expensive Orders (NEW FEATURE)
        const sortedByPrice = [...expenses].sort((a,b) => b.price - a.price).slice(0, 5);
        document.getElementById('expensiveList').innerHTML = sortedByPrice.map(order => {
            // Format date nicely
            const dateStr = order.date.replace("Placed at ", "").split(",")[0];
            // Get product summary (e.g. "Milk, Bread...")
            const prodSummary = order.products.slice(0, 3).join(", ") + (order.products.length > 3 ? "..." : "");
            
            return `
            <div class="exp-row">
                <div class="exp-info">
                    <span class="exp-date">${dateStr}</span>
                    <span class="exp-items">${prodSummary || "Grocery Items"}</span>
                </div>
                <div class="exp-price">‚Çπ${order.price.toLocaleString('en-IN')}</div>
            </div>`;
        }).join('');

        // 3. Most Frequent Products
        const counts = {};
        expenses.forEach(ord => {
          ord.products.forEach(p => { 
              // Cleanup name
              let name = p.trim();
              counts[name] = (counts[name] || 0) + 1; 
          });
        });
        
        const sortedFreq = Object.keys(counts).sort((a,b) => counts[b] - counts[a]).slice(0, 5);
        
        if (sortedFreq.length === 0) {
             document.getElementById('topList').innerHTML = "<div style='text-align:center; color:#999; font-size:12px; padding:10px;'>No product names found (Icons hidden)</div>";
        } else {
            document.getElementById('topList').innerHTML = sortedFreq.map(name => `
            <div class="prod-row">
                <span class="count-badge">${counts[name]}x</span>
                <span class="prod-name">${name}</span>
            </div>
            `).join('');
        }
      });
    }

    // --- THE SCRAPER (Runs on Zepto Page) ---
    function scrapePage() {
      const orders = [];
      
      // 1. Find all "Placed at" timestamps (This is the anchor for every order card)
      // Use a TreeWalker to find text nodes containing "Placed at"
      const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null, false);
      const dateNodes = [];
      let node;
      while(node = walker.nextNode()) {
          if(node.textContent.includes('Placed at')) {
              dateNodes.push(node.parentElement);
          }
      }

      dateNodes.forEach(dateEl => {
        // 2. Intelligent Card Isolation
        // Walk up parents until we find the container that has the Price
        let card = dateEl.parentElement;
        let validCard = null;
        
        // Climb max 6 levels
        for(let i=0; i<6; i++) {
          if(card) {
             const text = card.innerText || "";
             // Check if this container has a price like ‚Çπ174
             if(text.match(/[‚Çπ|Rs]\s?[0-9,]+/)) {
               // We found a container with price. 
               // BUT, we must ensure it's not the "Page Wrapper" containing ALL orders.
               // We check if it has multiple "Placed at" strings. If so, it's too big.
               const dateCount = (text.match(/Placed at/g) || []).length;
               if (dateCount === 1) {
                   validCard = card;
               }
             }
             card = card.parentElement;
          }
        }

        if(!validCard) return;

        const text = validCard.innerText;

        // A. Extract Price
        const priceMatch = text.match(/[‚Çπ|Rs]\s?([0-9,]+)/);
        if(!priceMatch) return;
        const price = parseFloat(priceMatch[1].replace(/,/g, ''));

        // B. Extract Date
        const dateMatch = text.match(/Placed at\s(.+)/);
        const date = dateMatch ? dateMatch[0] : "Unknown";

        // C. Extract Products (Strict Filter)
        const products = [];
        const images = validCard.querySelectorAll('img');
        images.forEach(img => {
          const alt = (img.alt || "").toLowerCase();
          const src = (img.src || "").toLowerCase();
          
          // BLOCKLIST: Ignore UI Icons
          if(alt.includes('arrow') || alt.includes('icon') || alt.includes('status') || 
             alt.includes('delivered') || src.includes('.svg')) return;
          
          if(img.alt && img.alt.length > 2) {
             // Capitalize first letter
             let cleanName = img.alt.charAt(0).toUpperCase() + img.alt.slice(1);
             products.push(cleanName);
          }
        });

        orders.push({ date, price, products });
      });
      
      return orders;
    }
  </script>
</body>
</html>
